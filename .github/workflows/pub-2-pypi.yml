name: å‘å¸ƒåˆ° PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘å‘å¸ƒï¼ˆç”¨äºæµ‹è¯•æˆ–ç´§æ€¥å‘å¸ƒï¼‰

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # ç”¨äº PyPI çš„ trusted publishing

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: agio-frontend/package-lock.json

    - name: å®‰è£… Python æ„å»ºå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: æ¸…ç†ä¹‹å‰çš„æ„å»º
      run: |
        rm -rf dist/ build/ *.egg-info
        rm -rf agio/frontend

    - name: æ„å»ºå‰ç«¯
      working-directory: ./agio-frontend
      run: |
        npm ci
        npm run build

    - name: å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
      run: |
        mkdir -p agio/frontend
        cp -r agio-frontend/dist agio/frontend/
        echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©å·²å¤åˆ¶"

    - name: æ£€æŸ¥ç‰ˆæœ¬å·ä¸€è‡´æ€§
      run: |
        PYPROJECT_VERSION=$(grep '^version =' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        INIT_VERSION=$(grep '__version__' agio/__init__.py | sed "s/__version__ = \"\(.*\)\"/\1/")
        if [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
          echo "âŒ ç‰ˆæœ¬å·ä¸ä¸€è‡´!"
          echo "   pyproject.toml: $PYPROJECT_VERSION"
          echo "   agio/__init__.py: $INIT_VERSION"
          exit 1
        fi
        echo "âœ… ç‰ˆæœ¬å·ä¸€è‡´: $PYPROJECT_VERSION"

    - name: æ„å»º Python åŒ…
      run: |
        python -m build

    - name: æ£€æŸ¥åŒ…
      run: |
        python -m twine check dist/*

    - name: å‘å¸ƒåˆ° TestPyPIï¼ˆæµ‹è¯•ï¼‰
      if: github.event_name == 'workflow_dispatch'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "âš ï¸  TEST_PYPI_API_TOKEN æœªè®¾ç½®ï¼Œè·³è¿‡ TestPyPI å‘å¸ƒ"
          exit 0
        fi
        echo "ğŸ“¤ å‘å¸ƒåˆ° TestPyPI..."
        python -m twine upload --repository testpypi dist/*
        echo "âœ… å·²å‘å¸ƒåˆ° TestPyPI"

    - name: å‘å¸ƒåˆ° PyPIï¼ˆç”Ÿäº§ï¼‰
      if: github.event_name == 'release' && github.event.action == 'published'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "âŒ PYPI_API_TOKEN æœªè®¾ç½®ï¼Œæ— æ³•å‘å¸ƒåˆ° PyPI"
          exit 1
        fi
        echo "ğŸ“¤ å‘å¸ƒåˆ° PyPI..."
        python -m twine upload dist/*
        echo "âœ… å·²å‘å¸ƒåˆ° PyPI"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/*
        retention-days: 7