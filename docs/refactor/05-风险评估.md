# 五、风险评估与缓解

## 5.1 风险矩阵

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| StepRunner 重构影响 Agent 执行 | 中 | 高 | 保留核心逻辑，只移除 Run 管理 |
| AgentRun → Run 迁移影响 API | 中 | 中 | 渐进式迁移，不保留向后兼容 |
| Workflow 依赖注入变更 | 低 | 中 | 同时修改所有 Workflow 子类 |
| RunnableExecutor 集成遗漏 | 中 | 中 | 全局搜索验证所有调用点 |
| Metrics 统一导致数据不一致 | 低 | 高 | 充分测试，确保字段映射正确 |
| WorkflowState 查询优化影响 Resume | 低 | 中 | 充分测试 Fork+Resume 场景 |

## 5.2 回滚策略

每个 Phase 完成后：
1. 运行全量测试
2. 如测试失败，使用 Git 回滚到 Phase 开始前状态
3. 分析失败原因，调整方案后重试

## 5.3 渐进式迁移策略

为降低风险，采用**渐进式迁移**：
1. Phase 1-3 完成后，新旧代码并存
2. RunnableExecutor 可选使用（Phase 5 创建后）
3. Phase 6 集成后统一清理
4. Phase 7 完成模型迁移
5. Phase 8 优化查询逻辑
6. Phase 9 全面验证

## 5.4 关键检查点

### Phase 1 完成后
- [ ] 所有 import 路径正确
- [ ] Metrics 定义统一
- [ ] 协议迁移完成

### Phase 4 完成后
- [ ] StepRunner 不再创建 Run
- [ ] StepRunner 不再发射 Run 级别事件
- [ ] RunOutput.metrics 正确返回

### Phase 5 完成后
- [ ] RunnableExecutor 正确创建和保存 Run
- [ ] Run 级别事件正确发射

### Phase 6 完成后
- [ ] API 层使用 RunnableExecutor
- [ ] Workflow 内部使用 RunnableExecutor
- [ ] 嵌套执行正确创建 Run 记录

### Phase 7 完成后
- [ ] 无 AgentRun 遗留引用
- [ ] API 响应字段正确更新

### Phase 8 完成后
- [ ] Fork+Resume 场景正确工作
- [ ] WorkflowState 正确加载历史
