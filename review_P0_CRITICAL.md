# Agio 项目代码审查 - P0 关键问题

## 概述
本文档列出影响系统稳定性、安全性和核心功能的关键问题，需要优先处理。

---

## 1. 并发安全问题

### 1.1 全局单例缺少线程安全保障
**位置**: `agio/config/system.py`

**问题描述**:
- `ConfigSystem` 使用全局单例模式，但只在初始化时加锁
- 运行时的 `save_config`、`delete_config`、`rebuild` 等操作缺少并发控制
- 多个请求同时修改配置可能导致状态不一致

**影响**:
- 高并发场景下配置状态可能损坏
- 热重载时可能出现竞态条件

**改进方向**:
- 对所有修改操作添加读写锁
- 考虑使用不可变配置 + Copy-on-Write 模式
- 或彻底移除全局单例，改用依赖注入

---

### 1.2 SessionStore 序列号分配的并发安全性
**位置**: `agio/storage/session/base.py`, `agio/storage/session/mongo.py`

**问题描述**:
- `InMemorySessionStore.allocate_sequence()` 使用 asyncio.Lock，但只能保证单进程并发安全
- MongoDB 实现使用 `find_one_and_update`，但缺少唯一索引保障
- 多进程/多实例部署时可能分配重复序列号

**影响**:
- 分布式部署下步骤顺序可能错乱
- 数据一致性无法保证

**改进方向**:
- 使用数据库级别的原子操作（如 MongoDB 的 `$inc`）
- 添加唯一索引约束 `(session_id, sequence)`
- 考虑使用分布式锁（Redis）或雪花算法

---

## 2. 错误处理缺陷

### 2.1 Wire 关闭后写入未捕获
**位置**: `agio/runtime/wire.py`

**问题描述**:
- `Wire.write()` 在队列关闭后写入会抛出异常
- 调用方未统一捕获此异常
- 可能导致整个执行流程中断

**影响**:
- 用户主动取消请求时可能出现未处理异常
- 日志中充斥大量错误信息

**改进方向**:
- `Wire.write()` 在关闭后静默忽略或返回错误标志
- 在关键路径上添加异常捕获和优雅降级
- 添加 `is_closed()` 检查方法

---

### 2.2 Tool 执行超时缺少全局控制
**位置**: `agio/tools/executor.py`

**问题描述**:
- 工具执行超时依赖各工具自行实现
- 缺少统一的超时控制机制
- 某些工具（如 web_fetch）可能无限期挂起

**影响**:
- 单个工具挂起可能阻塞整个 Agent 执行
- 资源无法及时释放

**改进方向**:
- 在 `ToolExecutor` 层面添加统一超时控制
- 使用 `asyncio.wait_for()` 包装所有工具调用
- 超时后强制取消并返回错误结果

---

## 3. 资源泄漏风险

### 3.1 异步任务未正确清理
**位置**: `agio/api/routes/runnables.py`, `agio/runtime/runnable_executor.py`

**问题描述**:
- 多处使用 `asyncio.create_task()` 但未追踪任务状态
- 异常情况下任务可能成为"僵尸任务"
- `finally` 块中的 `task.cancel()` 无法保证任务真正停止

**影响**:
- 长时间运行可能累积大量未完成任务
- 内存泄漏和 CPU 资源浪费

**改进方向**:
- 使用 `asyncio.TaskGroup` (Python 3.11+) 或自定义任务管理器
- 确保所有任务在请求结束时被正确取消和清理
- 添加任务监控和定期清理机制

---

### 3.2 Playwright Browser 实例未释放
**位置**: `agio/tools/builtin/web_fetch_tool/playwright/`

**问题描述**:
- CDP Browser 和 Chrome Session 管理复杂
- 异常情况下浏览器进程可能未关闭
- 缺少全局资源管理器

**影响**:
- 浏览器进程累积导致系统资源耗尽
- 文件句柄泄漏

**改进方向**:
- 实现统一的 BrowserPool 管理器
- 添加浏览器进程超时自动清理
- 使用上下文管理器确保资源释放

---

## 4. 数据一致性问题

### 4.1 Step 保存批量操作缺少事务
**位置**: `agio/runtime/step_repository.py`

**问题描述**:
- `StepRepository.flush()` 使用 `save_steps_batch()`
- 批量保存失败时部分 Step 可能已写入
- 缺少回滚机制

**影响**:
- 数据部分写入可能导致状态不一致
- 查询历史时可能缺失关键步骤

**改进方向**:
- 使用数据库事务确保原子性
- 添加重试机制
- 保存失败时记录详细错误并告警

---

### 4.2 热重载期间的请求处理
**位置**: `agio/config/hot_reload.py`

**问题描述**:
- 配置重载期间新请求可能使用不一致的组件
- 缺少请求排队或拒绝机制
- 可能导致使用已销毁的资源

**影响**:
- 重载期间请求失败或行为异常
- 难以追踪和复现

**改进方向**:
- 实现优雅的热重载策略（蓝绿部署）
- 重载期间暂停新请求接入或返回 503
- 等待进行中的请求完成后再切换配置

---

## 5. 安全性问题

### 5.1 工具权限检查可被绕过
**位置**: `agio/runtime/permission/manager.py`

**问题描述**:
- `PermissionManager` 只在 `ToolExecutor` 中调用
- 直接调用工具的 `execute()` 方法可以绕过权限检查
- 缺少强制性的权限校验机制

**影响**:
- 高风险工具可能被未授权执行
- 安全策略失效

**改进方向**:
- 在 `BaseTool.execute()` 层面强制检查权限
- 使用装饰器或代理模式确保无法绕过
- 添加审计日志记录所有工具调用

---

### 5.2 配置文件注入风险
**位置**: `agio/config/loader.py`, `agio/config/template.py`

**问题描述**:
- YAML 配置使用 `yaml.safe_load()` 但缺少额外验证
- Jinja2 模板渲染未限制可访问的对象和函数
- 恶意配置文件可能执行任意代码

**影响**:
- 配置文件可能被注入恶意代码
- 系统安全性严重受威胁

**改进方向**:
- 使用 `jinja2.sandbox.SandboxedEnvironment`
- 严格限制模板可访问的变量和函数
- 添加配置文件签名验证机制

---

## 6. 可观测性缺失

### 6.1 关键路径缺少 Trace
**位置**: 多个核心执行路径

**问题描述**:
- 配置加载、依赖解析、组件构建等关键流程缺少 Trace
- 无法追踪性能瓶颈
- 故障排查困难

**影响**:
- 生产环境问题难以定位
- 性能优化缺少数据支撑

**改进方向**:
- 为所有关键路径添加 OpenTelemetry Span
- 记录关键决策点和耗时
- 添加性能指标收集

---

### 6.2 错误日志信息不足
**位置**: 全局

**问题描述**:
- 许多异常只记录 error message，缺少 stack trace
- 缺少请求上下文信息（session_id, run_id 等）
- 难以关联日志和具体请求

**影响**:
- 故障排查耗时长
- 无法快速定位问题根因

**改进方向**:
- 统一异常处理和日志记录格式
- 使用结构化日志（structlog）
- 自动附加请求上下文到所有日志

---

## 优先级排序

1. **最高优先级**（立即处理）:
   - 1.2 序列号分配并发安全
   - 3.1 异步任务清理
   - 5.1 工具权限检查

2. **高优先级**（本周内）:
   - 1.1 ConfigSystem 并发控制
   - 2.2 工具超时控制
   - 4.2 热重载请求处理

3. **中优先级**（本月内）:
   - 2.1 Wire 异常处理
   - 3.2 Playwright 资源管理
   - 6.2 日志改进

4. **持续改进**:
   - 4.1 数据事务
   - 5.2 配置安全
   - 6.1 可观测性
