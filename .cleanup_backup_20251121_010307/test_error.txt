/Users/hongv/opt/miniconda3/lib/python3.12/site-packages/pytest_asyncio/plugin.py:217: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))
============================= test session starts ==============================
platform darwin -- Python 3.12.2, pytest-8.3.5, pluggy-1.5.0 -- /Users/hongv/opt/miniconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/hongv/workspace/agio
plugins: typeguard-4.4.1, time-machine-2.16.0, cov-6.2.1, mock-3.14.1, anyio-3.7.1, asyncio-0.26.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_agent_runner.py::test_event_handler_tool_call FAILED          [100%]

=================================== FAILURES ===================================
_________________________ test_event_handler_tool_call _________________________

mock_agent = <MagicMock spec='Agent' id='5094252400'>
mock_session = <MagicMock spec='AgentSession' id='5094256624'>

    @pytest.mark.asyncio
    async def test_event_handler_tool_call(mock_agent, mock_session):
        """Test EventHandler handling TOOL_CALL events"""
        runner = AgentRunner(agent=mock_agent, hooks=[])
    
        from agio.domain.run import AgentRun
        run = AgentRun(
            agent_id="test_agent",
            input_query="test query",
            session_id="test_session",
            user_id="test_user"
        )
    
        handler = EventHandler(runner, run, [])
    
        # 1. Tool Call Started
        start_event = ModelEvent(
            type=ModelEventType.TOOL_CALL_STARTED,
            tool_calls=[{
                "id": "call_1",
                "function": {"name": "test_tool", "arguments": "{}"}
            }],
            step=1
        )
    
        events = []
        async for event in handler.handle(start_event):
            events.append(event)
    
        assert len(events) == 1
        assert events[0].type == AgentEventType.TOOL_CALL_STARTED
        assert events[0].data["tool_name"] == "test_tool"
        assert handler.step_num == 1
        assert handler.current_step is not None
    
        # 2. Tool Call Finished
        finish_event = ModelEvent(
            type=ModelEventType.TOOL_CALL_FINISHED,
            tool_result={
                "tool_name": "test_tool",
                "tool_call_id": "call_1",
                "content": "result",
                "is_success": True,
                "duration": 0.1
            },
            step=1
        )
    
        events = []
>       async for event in handler.handle(finish_event):

tests/test_agent_runner.py:115: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
agio/runners/event_handler.py:57: in handle
    async for e in self._handle_tool_call_finished(event):
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <agio.runners.event_handler.EventHandler object at 0x129293fb0>
event = ModelEvent(type=<ModelEventType.TOOL_CALL_FINISHED: 'tool_call_finished'>, content=None, tool_calls=None, tool_result=..., 'tool_call_id': 'call_1', 'content': 'result', 'is_success': True, 'duration': 0.1}, usage=None, step=1, metadata={})

    async def _handle_tool_call_finished(self, event: ModelEvent) -> AsyncIterator[AgentEvent]:
>       tool_result = ToolResult(**event.tool_result)
E       pydantic_core._pydantic_core.ValidationError: 4 validation errors for ToolResult
E       input_args
E         Field required [type=missing, input_value={'tool_name': 'test_tool'...: True, 'duration': 0.1}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       output
E         Field required [type=missing, input_value={'tool_name': 'test_tool'...: True, 'duration': 0.1}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       start_time
E         Field required [type=missing, input_value={'tool_name': 'test_tool'...: True, 'duration': 0.1}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       end_time
E         Field required [type=missing, input_value={'tool_name': 'test_tool'...: True, 'duration': 0.1}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

agio/runners/event_handler.py:123: ValidationError
=============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: Type google._upb._message.MessageMapContainer uses PyType_Spec with a metaclass that has custom tp_new. This is deprecated and will no longer be allowed in Python 3.14.

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: Type google._upb._message.ScalarMapContainer uses PyType_Spec with a metaclass that has custom tp_new. This is deprecated and will no longer be allowed in Python 3.14.

../../opt/miniconda3/lib/python3.12/site-packages/pydantic/_internal/_config.py:268
  /Users/hongv/opt/miniconda3/lib/python3.12/site-packages/pydantic/_internal/_config.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/test_agent_runner.py::test_event_handler_tool_call
  /Users/hongv/opt/miniconda3/lib/python3.12/unittest/mock.py:529: PydanticDeprecatedSince20: The `__fields__` attribute is deprecated, use `model_fields` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    if iscoroutinefunction(getattr(spec, attr, None)):

tests/test_agent_runner.py::test_event_handler_tool_call
  /Users/hongv/opt/miniconda3/lib/python3.12/site-packages/pydantic/_internal/_model_construction.py:248: PydanticDeprecatedSince20: The `__fields__` attribute is deprecated, use `model_fields` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn('The `__fields__` attribute is deprecated, use `model_fields` instead.', DeprecationWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_agent_runner.py::test_event_handler_tool_call - pydantic_co...
======================== 1 failed, 5 warnings in 1.40s =========================
